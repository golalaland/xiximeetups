<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Xixi ‚Äî Money Talk üí∏</title>
  <link rel="icon" href="data:," />
  <style>
    :root{
      --bg:#000;
      --card:#111;
      --muted:#aaa;
      --accent:#ff007f; /* sexy deep pink */
      --radius:12px;
    }
    body{
      margin:0;
      background:var(--bg);
      color:white;
      font-family:sans-serif;
      display:flex;
      flex-direction:column;
      height:100vh;
    }
    header{
      padding:10px;
      text-align:center;
      background:var(--card);
      font-size:20px;
      color:var(--accent);
    }
    #video{
      flex:0 0 200px;
      background:#222;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #chat{
      flex:1;
      overflow-y:auto;
      padding:10px;
    }
    .msg{
      padding:8px 12px;
      margin:5px 0;
      background:var(--card);
      border-radius:var(--radius);
    }
    #typebar{
      display:flex;
      padding:10px;
      background:var(--card);
    }
    #typebar input{
      flex:1;
      padding:8px;
      border:none;
      border-radius:var(--radius);
      margin-right:8px;
    }
    #typebar button{
      background:var(--accent);
      color:white;
      border:none;
      padding:8px 16px;
      border-radius:var(--radius);
    }
    #auth, #username-setup{
      padding:20px;
      text-align:center;
    }
    #auth button, #username-setup button{
      background:var(--accent);
      color:white;
      border:none;
      padding:10px 20px;
      border-radius:var(--radius);
      cursor:pointer;
      margin-top:10px;
    }
    #redeem{
      display:none;
      margin:10px;
      text-align:center;
    }
    #redeem button{
      background:var(--accent);
      border:none;
      color:white;
      padding:10px 20px;
      border-radius:var(--radius);
      cursor:pointer;
    }
  </style>
</head>
<body>
  <header>Xixi ‚Äî Money Talk üí∏</header>

  <div id="video">üé• Video Frame</div>

  <!-- Auth screen -->
  <div id="auth">
    <p>Sign in to join chat</p>
    <button id="googleSignIn">Sign in with Google</button>
  </div>

  <!-- Username setup -->
  <div id="username-setup" style="display:none;">
    <p>Choose your chat ID</p>
    <input id="usernameInput" placeholder="Enter a username" />
    <button id="saveUsername">Save</button>
  </div>

  <!-- Chat -->
  <div id="chat" style="display:none;"></div>

  <!-- Typebar -->
  <div id="typebar" style="display:none;">
    <input id="msgInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>

  <!-- Redeem -->
  <div id="redeem">
    <button id="redeemBtn">üéÅ Redeem Stars</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
      authDomain: "metaverse-1010.firebaseapp.com",
      projectId: "metaverse-1010",
      storageBucket: "metaverse-1010.appspot.com",
      messagingSenderId: "1044064238233",
      appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
      measurementId: "G-S77BMC266C"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const authDiv = document.getElementById("auth");
    const usernameDiv = document.getElementById("username-setup");
    const chatDiv = document.getElementById("chat");
    const typebar = document.getElementById("typebar");
    const redeemDiv = document.getElementById("redeem");
    const googleBtn = document.getElementById("googleSignIn");
    const saveUsernameBtn = document.getElementById("saveUsername");
    const sendBtn = document.getElementById("sendBtn");

    let currentUser = null;
    let username = null;

    // Sign in
    googleBtn.onclick = async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert("Sign in failed: " + e.message);
      }
    };

    // Auth listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        const userRef = doc(db, "users", user.uid);
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
          // first time user ‚Üí assign guest with random number (not 0000)
          let rand = Math.floor(1 + Math.random() * 9999); 
          let guestName = "Guest " + rand;
          await setDoc(userRef, { username: guestName, stars: 0 });
          username = guestName;
        } else {
          username = snap.data().username || null;
        }

        if (!username || username.startsWith("Guest")) {
          authDiv.style.display = "none";
          usernameDiv.style.display = "block";
        } else {
          loadChat();
        }
      } else {
        currentUser = null;
        username = null;
        chatDiv.style.display = "none";
        typebar.style.display = "none";
        redeemDiv.style.display = "none";
        authDiv.style.display = "block";
      }
    });

    // Save username
    saveUsernameBtn.onclick = async () => {
      const uname = document.getElementById("usernameInput").value.trim();
      if (!uname) return alert("Enter a username");
      const userRef = doc(db, "users", currentUser.uid);
      await updateDoc(userRef, { username: uname });
      username = uname;
      usernameDiv.style.display = "none";
      loadChat();
    };

    // Load chat
    function loadChat() {
      authDiv.style.display = "none";
      usernameDiv.style.display = "none";
      chatDiv.style.display = "block";
      typebar.style.display = "flex";
      redeemDiv.style.display = "block";

      const q = query(collection(db, "messages"), orderBy("time"));
      onSnapshot(q, (snap) => {
        chatDiv.innerHTML = "";
        snap.forEach((doc) => {
          const m = doc.data();
          const div = document.createElement("div");
          div.className = "msg";
          div.textContent = m.username + ": " + m.text;
          chatDiv.appendChild(div);
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
      });
    }

    // Milestone alert
    function checkMilestones(stars) {
      const milestones = [50, 100, 200, 500, 1000];
      if (milestones.includes(stars)) {
        alert("üéâ Congrats! You reached " + stars + " stars!");
      }
    }

    // Send message
    sendBtn.onclick = async () => {
      const text = document.getElementById("msgInput").value.trim();
      if (!text) return;
      document.getElementById("msgInput").value = "";
      await addDoc(collection(db, "messages"), {
        uid: currentUser.uid,
        username,
        text,
        time: serverTimestamp()
      });
      // give stars
      const userRef = doc(db, "users", currentUser.uid);
      const snap = await getDoc(userRef);
      let stars = (snap.data().stars || 0) + 1;
      await updateDoc(userRef, { stars });
      checkMilestones(stars);
    };
  </script>
</body>
</html>

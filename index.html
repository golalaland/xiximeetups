<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi — Money Talk 💸</title>
<link rel="icon" href="data:," />
<style>
:root{
  --bg:#000;
  --card:#111;
  --muted:#aaa;
  --accent:#f1f1f1;
}
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:var(--bg);
  color:var(--accent);
  display:flex;
  flex-direction:column;
  height:100vh;
}
header,footer{
  background:var(--card);
  padding:10px;
  text-align:center;
}
main{
  flex:1;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
#videoFrame{
  flex:1;
  border:none;
  width:100%;
}
#chat{
  flex:1;
  display:flex;
  flex-direction:column;
}
#messages{
  flex:1;
  overflow-y:auto;
  padding:10px;
}
.msg{
  margin:5px 0;
  padding:8px 12px;
  border-radius:12px;
  max-width:75%;
  word-wrap:break-word;
}
.msg.me{
  margin-left:auto;
  background:rgba(223,244,31,0.08);
}
.msg.other{
  margin-right:auto;
  background:rgba(255,255,255,0.08);
}
#inputArea{
  display:flex;
  padding:10px;
  border-top:1px solid #222;
}
#inputArea input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:20px;
  outline:none;
}
#inputArea button{
  margin-left:10px;
  padding:10px 20px;
  border:none;
  border-radius:20px;
  background:#dfdf1f;
  cursor:pointer;
}
#authArea{
  text-align:center;
  padding:20px;
}
.hidden{display:none;}
#stars{margin:10px;font-size:14px;}
#redeemBtn{
  background:#444;
  padding:6px 12px;
  border-radius:8px;
  cursor:pointer;
  margin:10px;
  display:inline-block;
}
</style>
</head>
<body>
<header>
  <h2>Xixi — Money Talk 💸</h2>
  <div id="stars">⭐ Stars: <span id="starCount">0</span></div>
  <div id="redeemBtn" class="hidden">🎁 Redeem</div>
</header>
<main>
  <iframe id="videoFrame" src="https://player.vimeo.com/video/123456789" allowfullscreen></iframe>
  <div id="authArea">
    <button id="googleSignIn">Sign in with Google</button>
    <button id="guestSignIn">Continue as Guest</button>
  </div>
  <div id="chat" class="hidden">
    <div id="messages"></div>
    <div id="inputArea">
      <input id="msgInput" placeholder="Type a message..." />
      <button id="sendBtn">Send</button>
    </div>
  </div>
</main>
<footer>© 2025 Xixi</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// 🔥 Firebase Config
const firebaseConfig = {
  apiKey: "YOUR-API-KEY",
  authDomain: "YOUR.firebaseapp.com",
  projectId: "YOUR",
  storageBucket: "YOUR.appspot.com",
  messagingSenderId: "YOUR",
  appId: "YOUR"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const googleBtn = document.getElementById("googleSignIn");
const guestBtn = document.getElementById("guestSignIn");
const authArea = document.getElementById("authArea");
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const messagesDiv = document.getElementById("messages");
const starsEl = document.getElementById("starCount");
const redeemBtn = document.getElementById("redeemBtn");

let currentUser = null;
let username = null;
let color = null;

// 🎨 Random color for each session
function randomColor(){
  const colors=["#f39c12","#e74c3c","#9b59b6","#3498db","#1abc9c","#2ecc71","#ff00ff","#00ffff"];
  return colors[Math.floor(Math.random()*colors.length)];
}

// 🔢 Generate random guest ID (no 0000)
function randomGuestId(){
  return Math.floor(1001 + Math.random()*8999); // avoids 0000-1000
}

// 🌟 Sync stars in real-time
async function setupStars(uid){
  const userRef = doc(db,"users",uid);
  const snap = await getDoc(userRef);
  if(!snap.exists()){
    await setDoc(userRef,{stars:0,username,createdAt:serverTimestamp()});
  }
  onSnapshot(userRef,(docSnap)=>{
    if(docSnap.exists()){
      starsEl.textContent = docSnap.data().stars || 0;
    }
  });
}

// 📩 Send message
async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;
  await addDoc(collection(db,"messages"),{
    text,
    uid:currentUser.uid,
    username,
    color,
    createdAt:serverTimestamp()
  });
  msgInput.value="";
  msgInput.focus();

  // ⭐ Add star to user
  const userRef = doc(db,"users",currentUser.uid);
  const snap = await getDoc(userRef);
  if(snap.exists()){
    const stars=(snap.data().stars||0)+1;
    await updateDoc(userRef,{stars});
  }
}

// 💬 Listen to messages live
function listenMessages(){
  const q=query(collection(db,"messages"),orderBy("createdAt"));
  onSnapshot(q,(snap)=>{
    messagesDiv.innerHTML="";
    snap.forEach(docSnap=>{
      const m=docSnap.data();
      const div=document.createElement("div");
      div.classList.add("msg");
      if(m.uid===currentUser.uid){div.classList.add("me");}
      else{div.classList.add("other");}
      div.style.color=m.color||"#fff";
      div.textContent=`${m.username}: ${m.text}`;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
}

// 👤 Handle login state
onAuthStateChanged(auth,async(user)=>{
  if(user){
    currentUser=user;
    color=randomColor();
    username=user.displayName || "Guest"+randomGuestId();
    authArea.classList.add("hidden");
    chat.classList.remove("hidden");
    redeemBtn.classList.remove("hidden");
    await setupStars(user.uid);
    listenMessages();
  }else{
    currentUser=null;
    chat.classList.add("hidden");
    redeemBtn.classList.add("hidden");
    authArea.classList.remove("hidden");
  }
});

// 🔑 Google Sign In
googleBtn.onclick=async()=>{
  const provider=new GoogleAuthProvider();
  try{
    await signInWithPopup(auth,provider);
  }catch(e){alert("Google Sign-in failed: "+e.message);}
};

// 👤 Guest Sign In
guestBtn.onclick=async()=>{
  try{
    await signInAnonymously(auth);
  }catch(e){alert("Guest Sign-in failed: "+e.message);}
};

sendBtn.onclick=sendMessage;
msgInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendMessage();});
</script>
</body>
</html>

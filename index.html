<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xixi Chat</title>
  <style>
    body {margin:0;font-family:Arial,sans-serif;background:black;color:white;display:flex;flex-direction:column;height:100vh;}
    #authBox,#chatBox{margin:auto;text-align:center;}
    #chatBox{display:none;flex-direction:column;width:100%;height:100%;}
    #messages{flex:1;overflow-y:auto;padding:10px;scroll-behavior:smooth;}
    .msg{margin:5px 0;padding:8px 12px;border-radius:10px;max-width:70%;text-align:left;opacity:0;animation:fadeIn 0.3s forwards;}
    .msg.me{background:rgba(223,244,31,0.08);margin-left:0;}
    .msg.other{background:rgba(255,255,255,0.1);margin-right:0;}
    .send-area{display:flex;padding:10px;border-top:1px solid #333;position:sticky;bottom:env(safe-area-inset-bottom);}
    .send-area input{flex:1;padding:10px;border:none;border-radius:20px;margin-right:10px;}
    .send-area button{padding:10px 20px;border:none;border-radius:20px;background:#dfF41F;color:black;cursor:pointer;}
    #starCount.bump{animation:bump 0.3s;}
    @keyframes bump{0%{transform:scale(1);}50%{transform:scale(1.3);}100%{transform:scale(1);}}
    @keyframes fadeIn{to{opacity:1;}}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="authBox">
    <h2>Sign In</h2>
    <input id="authUsername" placeholder="Chat ID" autofocus><br><br>
    <button id="signinBtn">Sign In</button>
    <button id="signupBtn">Sign Up</button><br><br>
    <button id="googleBtn">Sign In with Google</button>
  </div>
  
  <div id="chatBox">
    <div id="messages"></div>
    <div class="send-area">
      <input id="messageInput" placeholder="Type a message...">
      <button id="sendBtn">Send</button>
    </div>
    <div id="adminPanel" style="display:none;margin:10px;">
      <button id="logoutBtn">Logout</button>
    </div>
    <div style="padding:10px;">‚≠ê Stars: <span id="starCount">0</span></div>
  </div>

<script>
  const firebaseConfig = { /* your firebase config */ };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const authBox=document.getElementById("authBox");
  const chatBox=document.getElementById("chatBox");
  const signinBtn=document.getElementById("signinBtn");
  const signupBtn=document.getElementById("signupBtn");
  const googleBtn=document.getElementById("googleBtn");
  const logoutBtn=document.getElementById("logoutBtn");
  const msgInput=document.getElementById("messageInput");
  const sendBtn=document.getElementById("sendBtn");
  const messagesDiv=document.getElementById("messages");
  const starCountEl=document.getElementById("starCount");

  // Auth events
  signinBtn.onclick=()=>{
    const email=document.getElementById("authUsername").value+"@xixi.com";
    const pw="defaultpass";
    signinBtn.textContent="Signing in...";
    auth.signInWithEmailAndPassword(email,pw).catch(alert).finally(()=>signinBtn.textContent="Sign In");
  };
  signupBtn.onclick=()=>{
    const email=document.getElementById("authUsername").value+"@xixi.com";
    const pw="defaultpass";
    signupBtn.textContent="Signing up...";
    auth.createUserWithEmailAndPassword(email,pw).catch(alert).finally(()=>signupBtn.textContent="Sign Up");
  };
  googleBtn.onclick=()=>{
    const provider=new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(alert);
  };
  logoutBtn.onclick=()=>{auth.signOut();};

  // Enter key for auth
  document.getElementById("authUsername").addEventListener("keypress",e=>{
    if(e.key==="Enter") signinBtn.click();
  });

  auth.onAuthStateChanged(user=>{
    if(user){
      authBox.style.display="none";
      chatBox.style.display="flex";
      if(user.email.includes("admin")) document.getElementById("adminPanel").style.display="block";
      addSystemMessage(`${user.displayName||user.email} joined the chat.`);
    }else{
      if(chatBox.style.display==="flex"){
        addSystemMessage("User left the chat.");
      }
      authBox.style.display="block";
      chatBox.style.display="none";
    }
  });

  function addSystemMessage(txt){
    const div=document.createElement("div");
    div.className="msg other";
    div.style.opacity=0.6;
    div.textContent=txt;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  }

  // Chat
  sendBtn.onclick=sendMessage;
  msgInput.addEventListener("keypress",e=>{
    if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage();}
  });

  function sendMessage(){
    const text=msgInput.value.trim();
    if(!text) return;
    const msg={text,uid:auth.currentUser.uid,ts:Date.now(),user:auth.currentUser.email};
    showMessage(msg,true);
    msgInput.value="";
    db.collection("messages").add(msg).then(()=>{
      starCountEl.classList.add("bump");
      setTimeout(()=>starCountEl.classList.remove("bump"),300);
    }).catch(err=>alert("Failed: "+err));
  }

  function showMessage(msg,isOptimistic=false){
    const div=document.createElement("div");
    div.className="msg "+(msg.uid===auth.currentUser?.uid?"me":"other");
    div.textContent=msg.user+": "+msg.text;
    messagesDiv.appendChild(div);
    if(messagesDiv.scrollHeight-messagesDiv.scrollTop<=messagesDiv.clientHeight+100){
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    }
  }

  db.collection("messages").orderBy("ts").onSnapshot(snap=>{
    messagesDiv.innerHTML="";
    snap.forEach(doc=>showMessage(doc.data()));
  });
</script>
</body>
</html>
